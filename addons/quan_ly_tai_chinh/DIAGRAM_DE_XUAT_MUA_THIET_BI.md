# Sơ đồ Luồng Dữ liệu - Đề xuất Mua Thiết bị

## 1. Sơ đồ Workflow

```
┌─────────────────────────────────────────────────────────────────┐
│                    QUY TRÌNH ĐỀ XUẤT MUA THIẾT BỊ              │
└─────────────────────────────────────────────────────────────────┘

[BƯỚC 1: TẠO ĐỀ XUẤT]
┌──────────────────┐
│  Người đề xuất   │
│  (Nhân viên)     │
└────────┬─────────┘
         │
         ▼
┌─────────────────────────────────┐
│  Tạo đề xuất mua thiết bị       │
│  - Tiêu đề                      │
│  - Phòng ban                    │
│  - Chi tiết thiết bị            │
│  - Lý do                        │
│  - File đính kèm                │
└────────┬────────────────────────┘
         │
         ▼
    [DRAFT] Nháp


[BƯỚC 2: GỬI PHÊ DUYỆT]
    [DRAFT]
         │
         │ action_submit()
         ▼
┌─────────────────────────────────┐
│  Gửi phê duyệt                  │
│  - Validate: Có chi tiết?       │
│  - Tạo activity cho Manager     │
└────────┬────────────────────────┘
         │
         ▼
  [SUBMITTED] Chờ phê duyệt


[BƯỚC 3: PHÊ DUYỆT / TỪ CHỐI]
  [SUBMITTED]
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌─────┐   ┌─────────┐
│ PHÊ │   │  TỪ     │
│ DUYỆT│  │  CHỐI   │
└──┬──┘   └────┬────┘
   │           │
   │           ▼
   │      [REJECTED]
   │           │
   │           │ action_reset_to_draft()
   │           ▼
   │       [DRAFT]
   │
   ▼
[APPROVED] Đã phê duyệt
   │
   │ (Tự động)
   ├──────────────────────────────┐
   │                              │
   ▼                              ▼
┌──────────────────┐    ┌────────────────────┐
│ action_create_   │    │ action_create_     │
│ assets()         │    │ journal_entry()    │
│                  │    │                    │
│ Tạo tài sản      │    │ Ghi sổ cái        │
└────────┬─────────┘    └────────┬───────────┘
         │                       │
         └───────────┬───────────┘
                     │
                     ▼
            [PURCHASED] Đã mua
```

## 2. Sơ đồ Tích hợp Module

```
┌────────────────────────────────────────────────────────────────────┐
│                       MODULE TÍCH HỢP                              │
└────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                    MODULE: qltc (Tài chính)                         │
│                                                                     │
│  ┌──────────────────────────────────────────────────────┐          │
│  │       Đề xuất Mua Thiết bị                           │          │
│  │  ┌────────────────────────────────────────┐          │          │
│  │  │  - Mã đề xuất: DXMT00001               │          │          │
│  │  │  - Tên: Mua máy tính cho phòng IT      │          │          │
│  │  │  - Số lượng: 10 máy                    │          │          │
│  │  │  - Đơn giá: 15,000,000 VNĐ             │          │          │
│  │  │  - Tổng: 150,000,000 VNĐ               │          │          │
│  │  └──────────────┬─────────────────────────┘          │          │
│  │                 │                                     │          │
│  │                 │ [PHÊ DUYỆT]                         │          │
│  │                 │                                     │          │
│  │    ┌────────────┴────────────┐                        │          │
│  │    │                         │                        │          │
│  └────┼─────────────────────────┼────────────────────────┘          │
│       │                         │                                   │
│       ▼                         ▼                                   │
│  ┌────────────────┐    ┌───────────────────┐                       │
│  │ TẠO TÀI SẢN    │    │ GHI SỔ CÁI        │                       │
│  └────────┬───────┘    └────────┬──────────┘                       │
└───────────┼─────────────────────┼────────────────────────────────────┘
            │                     │
            │                     │
            ▼                     ▼
┌───────────────────────┐  ┌──────────────────────────────────────┐
│  MODULE:              │  │  MODULE:                             │
│  quan_ly_tai_san      │  │  account (Kế toán)                   │
│                       │  │                                      │
│  ┌─────────────────┐  │  │  ┌────────────────────────────────┐ │
│  │ Tài sản 1       │  │  │  │ Bút toán                       │ │
│  │ MA: DXMT-1-001  │  │  │  │ Ref: Mua thiết bị - DXMT00001  │ │
│  │ Tên: Máy tính   │  │  │  │                                │ │
│  │ Giá: 15tr       │  │  │  │ Nợ TK 211: 150,000,000         │ │
│  └─────────────────┘  │  │  │ Có TK 112: 150,000,000         │ │
│                       │  │  │                                │ │
│  ┌─────────────────┐  │  │  │ Trạng thái: Posted             │ │
│  │ Tài sản 2       │  │  │  └────────────────────────────────┘ │
│  │ MA: DXMT-1-002  │  │  │                                      │
│  │ Tên: Máy tính   │  │  │  ▼                                   │
│  │ Giá: 15tr       │  │  │  ┌─────────────────────────────┐    │
│  └─────────────────┘  │  │  │ Ảnh hưởng:                  │    │
│         ...           │  │  │ - Sổ cái                    │    │
│  ┌─────────────────┐  │  │  │ - Báo cáo tài chính         │    │
│  │ Tài sản 10      │  │  │  │ - Dòng tiền                 │    │
│  │ MA: DXMT-1-010  │  │  │  │ - Kế toán quản trị          │    │
│  │ Tên: Máy tính   │  │  │  └─────────────────────────────┘    │
│  │ Giá: 15tr       │  │  │                                      │
│  └─────────────────┘  │  └──────────────────────────────────────┘
│                       │
│  ▼                    │
│  ┌─────────────────┐  │
│  │ Tham gia luồng: │  │
│  │ - Khấu hao      │  │
│  │ - Kiểm kê       │  │
│  │ - Mượn trả      │  │
│  │ - Phân bổ       │  │
│  │ - Thanh lý      │  │
│  │ - Bảo trì       │  │
│  └─────────────────┘  │
└───────────────────────┘
```

## 3. Sơ đồ Dữ liệu (Entity Relationship)

```
┌─────────────────────────────────────────────────────────────────┐
│                    ENTITY RELATIONSHIP DIAGRAM                  │
└─────────────────────────────────────────────────────────────────┘

┌──────────────────────────┐
│   res.users              │
│  - id                    │
│  - name                  │
└───────┬──────────────────┘
        │
        │ nguoi_de_xuat_id
        │ nguoi_phe_duyet_id
        │
        ▼
┌──────────────────────────────────────┐
│   de_xuat_mua_thiet_bi               │
│  - id                                │
│  - ma_de_xuat (Sequence)             │
│  - ten_de_xuat                       │
│  - ngay_de_xuat                      │
│  - nguoi_de_xuat_id ────────┐        │
│  - phong_ban_id             │        │
│  - tong_gia_tri (computed)  │        │
│  - state                    │        │
│  - nguoi_phe_duyet_id ──────┘        │
│  - ngay_phe_duyet                    │
│  - journal_entry_id ─────────────┐   │
└──────┬───────────────────────────┼───┘
       │                           │
       │ de_xuat_id                │
       │                           │
       ▼                           ▼
┌──────────────────────────┐  ┌──────────────────────┐
│ de_xuat_mua_thiet_bi.line│  │   account.move       │
│  - id                    │  │  - id                │
│  - de_xuat_id            │  │  - name              │
│  - ten_thiet_bi          │  │  - ref               │
│  - danh_muc_ts_id ───┐   │  │  - date              │
│  - so_luong          │   │  │  - state             │
│  - don_gia           │   │  └──────────────────────┘
│  - thanh_tien        │   │
│  - pp_khau_hao       │   │
│  - thoi_gian_su_dung │   │
└──────────────────────┘   │
                           │
                           │ danh_muc_ts_id
                           ▼
┌──────────────────────────────────────┐
│   danh_muc_tai_san                   │
│  - id                                │
│  - ma_danh_muc                       │
│  - ten_danh_muc                      │
└──────────────────────────────────────┘

┌──────────────────────────┐
│   hr.department          │
│  - id                    │
│  - name                  │
│  - manager_id            │
└───────▲──────────────────┘
        │
        │ phong_ban_id
        │
┌──────────────────────────────────────┐
│   de_xuat_mua_thiet_bi               │
│        (same as above)               │
└───────┬──────────────────────────────┘
        │
        │ tai_san_ids (Many2many)
        │
        ▼
┌──────────────────────────┐
│   tai_san                │
│  - id                    │
│  - ma_tai_san            │
│  - ten_tai_san           │
│  - ngay_mua_ts           │
│  - gia_tri_ban_dau       │
│  - danh_muc_ts_id        │
│  - pp_khau_hao           │
└──────────────────────────┘
```

## 4. Sơ đồ Luồng Dữ liệu Chi tiết

```
┌─────────────────────────────────────────────────────────────────┐
│              LUỒNG DỮ LIỆU SAU KHI PHÊ DUYỆT                    │
└─────────────────────────────────────────────────────────────────┘

[ĐỀ XUẤT]
DXMT00001
├─ Line 1: Máy tính Dell (Số lượng: 3)
└─ Line 2: Màn hình LG (Số lượng: 2)

        │
        │ action_approve()
        │
        ▼

[BƯỚC 1: TẠO TÀI SẢN]
┌───────────────────────────────────────┐
│ Loop qua Line 1 (Máy tính, SL=3)      │
│   └─ Tạo Tài sản: DXMT00001-1-001     │
│   └─ Tạo Tài sản: DXMT00001-1-002     │
│   └─ Tạo Tài sản: DXMT00001-1-003     │
│                                       │
│ Loop qua Line 2 (Màn hình, SL=2)      │
│   └─ Tạo Tài sản: DXMT00001-2-001     │
│   └─ Tạo Tài sản: DXMT00001-2-002     │
└───────────────────────────────────────┘
        │
        ▼
Tổng: 5 tài sản được tạo

        │
        │ Lưu vào tai_san_ids (Many2many)
        │
        ▼

┌───────────────────────────────────────┐
│ de_xuat_mua_thiet_bi                  │
│  tai_san_ids = [TS1, TS2, TS3, ...]  │
└───────────────────────────────────────┘


[BƯỚC 2: GHI SỔ CÁI]
┌───────────────────────────────────────┐
│ Tính tổng giá trị:                    │
│  Line 1: 3 × 15,000,000 = 45,000,000  │
│  Line 2: 2 × 5,000,000  = 10,000,000  │
│  ─────────────────────────────────    │
│  Tổng:                   55,000,000   │
└───────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────┐
│ Tìm tài khoản:                        │
│  TK Nợ:  211% (TSCĐ)                 │
│  TK Có:  112% (Tiền)                 │
└───────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────┐
│ Tạo account.move:                     │
│  Journal: Purchase                    │
│  Date: 2026-01-06                     │
│  Ref: "Mua thiết bị - DXMT00001"     │
│                                       │
│  Line 1:                              │
│    Account: 2111 (TSCĐ)               │
│    Debit:   55,000,000                │
│    Credit:  0                         │
│                                       │
│  Line 2:                              │
│    Account: 1121 (Tiền)               │
│    Debit:   0                         │
│    Credit:  55,000,000                │
└───────────────────────────────────────┘
        │
        │ action_post()
        ▼
┌───────────────────────────────────────┐
│ Bút toán đã đăng                      │
│  State: Posted                        │
│  Move Name: BILL/2026/0001            │
└───────────────────────────────────────┘
        │
        │ Lưu vào journal_entry_id
        │
        ▼
┌───────────────────────────────────────┐
│ de_xuat_mua_thiet_bi                  │
│  journal_entry_id = move.id           │
└───────────────────────────────────────┘


[BƯỚC 3: CẬP NHẬT TRẠNG THÁI]
        │
        ▼
┌───────────────────────────────────────┐
│ de_xuat_mua_thiet_bi                  │
│  state = 'purchased'                  │
└───────────────────────────────────────┘
```

## 5. Sơ đồ Use Case

```
┌─────────────────────────────────────────────────────────────────┐
│                         USE CASE DIAGRAM                        │
└─────────────────────────────────────────────────────────────────┘

        ┌──────────┐
        │  Nhân    │
        │  viên    │
        └────┬─────┘
             │
             │
    ┌────────▼──────────┐
    │ Tạo đề xuất       │
    └────────┬──────────┘
             │
    ┌────────▼──────────┐
    │ Gửi phê duyệt     │
    └────────┬──────────┘
             │
    ┌────────▼──────────┐
    │ Xem trạng thái    │
    └────────┬──────────┘
             │
    ┌────────▼──────────┐
    │ Hủy đề xuất       │
    └───────────────────┘


        ┌──────────┐
        │  Quản lý │
        │          │
        └────┬─────┘
             │
             │
    ┌────────▼──────────┐
    │ Phê duyệt         │
    │ đề xuất           │
    └────────┬──────────┘
             │
    ┌────────▼──────────┐
    │ Từ chối           │
    │ đề xuất           │
    └────────┬──────────┘
             │
    ┌────────▼──────────┐
    │ Xem báo cáo       │
    │ đề xuất           │
    └───────────────────┘


        ┌──────────┐
        │  Kế toán │
        │          │
        └────┬─────┘
             │
             │
    ┌────────▼──────────┐
    │ Xem bút toán      │
    │ ghi nhận          │
    └────────┬──────────┘
             │
    ┌────────▼──────────┐
    │ Xem báo cáo       │
    │ tài chính         │
    └────────┬──────────┘
             │
    ┌────────▼──────────┐
    │ Kiểm tra          │
    │ dòng tiền         │
    └───────────────────┘


        ┌──────────┐
        │  Quản lý │
        │  tài sản │
        └────┬─────┘
             │
             │
    ┌────────▼──────────┐
    │ Xem tài sản       │
    │ mới mua           │
    └────────┬──────────┘
             │
    ┌────────▼──────────┐
    │ Phân bổ tài sản   │
    │ cho phòng ban     │
    └────────┬──────────┘
             │
    ┌────────▼──────────┐
    │ Theo dõi          │
    │ khấu hao          │
    └───────────────────┘
```

## 6. Sơ đồ Quyền truy cập

```
┌─────────────────────────────────────────────────────────────────┐
│                    ACCESS CONTROL MATRIX                        │
└─────────────────────────────────────────────────────────────────┘

                        │ User │ Manager │ Admin │
                        │ (NV) │  (QL)   │       │
─────────────────────────┼──────┼─────────┼───────┤
Tạo đề xuất             │  ✓   │    ✓    │   ✓   │
Xem đề xuất của mình    │  ✓   │    ✓    │   ✓   │
Xem tất cả đề xuất      │  ✗   │    ✓    │   ✓   │
Sửa đề xuất (Draft)     │  ✓   │    ✓    │   ✓   │
Gửi phê duyệt           │  ✓   │    ✓    │   ✓   │
Phê duyệt đề xuất       │  ✗   │    ✓    │   ✓   │
Từ chối đề xuất         │  ✗   │    ✓    │   ✓   │
Hủy đề xuất             │  ✓   │    ✓    │   ✓   │
Xóa đề xuất             │  ✗   │    ✗    │   ✓   │
Xem tài sản đã tạo      │  ✓   │    ✓    │   ✓   │
Xem bút toán            │  ✗   │    ✓    │   ✓   │
─────────────────────────┴──────┴─────────┴───────┘

Ghi chú:
✓ = Có quyền
✗ = Không có quyền
```

---

**Lưu ý**: Các sơ đồ trên được vẽ bằng ASCII art để dễ hiểu và có thể xem trong bất kỳ text editor nào.
